name: Build LogVPN

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  NDK_VERSION: r26d

jobs:
  build-windows:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Prepare Windows (download core libs)
        shell: bash
        run: |
          mkdir -p windows/libcore
          curl -L https://github.com/hiddify/hiddify-next-core/releases/latest/download/libcore-windows-amd64.tar.gz -o libcore.tar.gz || \
          curl -L https://github.com/hiddify/hiddify-next-core/releases/download/draft/libcore-windows-amd64.tar.gz -o libcore.tar.gz
          tar -xzf libcore.tar.gz -C windows/libcore || echo "Failed to extract, continuing anyway"
          ls -la windows/libcore || dir windows\libcore
      
      - name: Build Windows
        run: flutter build windows --release --dart-define=sentry_dsn=""
      
      - name: Package Windows Portable
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "out"
          if (Test-Path "build\windows\x64\runner\Release") {
            Compress-Archive -Force -Path "build\windows\x64\runner\Release\*" -DestinationPath "out\LogVPN-Windows-Portable-x64.zip"
            echo "✅ Windows portable created"
          } else {
            echo "❌ Release directory not found"
            exit 1
          }
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: LogVPN-Windows
          path: out/

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
          link-to-sdk: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Prepare Android (download core libs)
        run: |
          mkdir -p android/app/src/main/jniLibs/arm64-v8a
          mkdir -p android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p android/app/src/main/jniLibs/x86_64
          curl -L https://github.com/hiddify/hiddify-next-core/releases/latest/download/libcore-android.tar.gz -o libcore.tar.gz || \
          curl -L https://github.com/hiddify/hiddify-next-core/releases/download/draft/libcore-android.tar.gz -o libcore.tar.gz
          tar -xzf libcore.tar.gz || echo "Failed to extract, continuing anyway"
          ls -la android/app/src/main/jniLibs/ || echo "jniLibs not found"
      
      - name: Build APK
        run: flutter build apk --release --split-per-abi --dart-define=sentry_dsn=""
      
      - name: Copy APK to out
        run: |
          mkdir -p out
          find build/app/outputs/flutter-apk -name "*.apk" -exec cp {} out/ \;
          ls -la out/
          # Rename files
          cd out
          for file in *.apk; do
            if [[ $file == *"arm64-v8a"* ]]; then
              mv "$file" "LogVPN-Android-arm64.apk"
            elif [[ $file == *"armeabi-v7a"* ]]; then
              mv "$file" "LogVPN-Android-arm7.apk"
            elif [[ $file == *"x86_64"* ]]; then
              mv "$file" "LogVPN-Android-x64.apk"
            fi
          done
          ls -la
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: LogVPN-Android
          path: out/*.apk
